# Sentry example

This sample shows how Dapr Sidekick can be used to host the Dapr Sentry service alongside a Dapr Sidecar instance. Sidekick will launch the Sentry service and wait for it
to enter a healthy running state, then will launch the Sidecar alongside. The Sidecar will be configured to use the launched Sentry service by default.
As with the Sidecar, the Sentry service will be continually monitored and maintained for the lifetime of the application.

## How Dapr Sidekick was added

This is an ASP.NET Core minimal Web API project. Dapr Sidekick was added to the [Program.cs](SentrySample\Program.cs) file as follows:

```csharp
// Add Dapr Sidekick with Sentry
builder.Services.AddDaprSidekick(builder.Configuration)
    .AddSentry();
```

Sentry requires some certificates on startup to configure the trust chain for its internal CA and the mTLS certificates it generates.
By default it will look for these in a `certs` subfolder under the runtime configuration folder, although this can
be overridden using the `--issuer-credentials` command-line argument which Sidekick supports via the `CertsDirectory` property:

```json5
"Sentry": {
  "CertsDirectory": "/path/to/certs/directory"
}
```

For this sample a `certs` folder has been included in the project which Sidekick will automatically use to configure Sentry.
The files contained in the folder were auto-generated by Sentry itself on startup.

The Sidecar is also configured to use the same certificates to enable mTLS, and on startup the launched Sentry
instance will assign an mTLS certificate to the sidecar with a TTL value defined by [configuration](SentrySample/sentry/config.yaml).
The Sidecar mTLS secrest are typically injected using environment variables, Sidekick supports also defining these
via configuration and will inject them as necessary. One way of achieving this is demonstrated in [Program.cs](SentrySample\Program.cs):

```csharp
// Inject Sentry certificates into the Dapr sidecar to verify mTLS operation
builder.Services.PostConfigure<DaprOptions>(options =>
{
    var certsFolder = "sentry/certs/";

    // Assign security defaults (trust chain, certificates and keys) from embedded resources.
    // This needs to be replaced with proper certificate distribution in the future.
    options.TrustAnchorsCertificate ??= File.ReadAllText(certsFolder + DaprConstants.TrustAnchorsCertificateFilename);
    options.IssuerCertificate ??= File.ReadAllText(certsFolder + DaprConstants.IssuerCertificateFilename);
    options.IssuerKey ??= File.ReadAllText(certsFolder + DaprConstants.IssuerKeyFilename);
});
```

## Running the sample

 To run the sample simply set `SentrySample` as the startup project and run it in Visual Studio,
 it will launch first the Sentry service then the Dapr sidecar, then open a browser and display
 the configured launch options for both.

